<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inställningar</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class=background_wrapper></div>
    <div class="card">
    <h1>Inställningar</h1>
    <div class="navigation">
        <a href="{{ url_for('main.index') }}">Inventera</a>
        <a href="{{ url_for('inventory.inventory') }}">Hantera artiklar</a>
        <a href="{{ url_for('settings.settings') }}" class="active">Inställningar</a>
        <a href="https://ha.snis.nu/ass-ds/0">Kalender m.m</a>
    </div>
    
    <div class="settings-section">
        <h2>Google Tasks Integration</h2>
        
        {% if authenticated %}
            <div class="alert success">
                <p>✓ Ansluten till Google Tasks</p>
            </div>
        {% else %}
            <div class="alert error">
                <p>✗ Inte ansluten till Google Tasks</p>
                {% if error_message %}
                    <p>Felmeddelande: {{ error_message }}</p>
                {% endif %}
            </div>
        {% endif %}
        
        <!-- Show credentials form if not authenticated -->
        {% if not authenticated %}
        <div class="auth-section">
            <h3>Google Tasks Autentisering</h3>
            
            <div class="auth-instructions">
                <p>För att ansluta till Google Tasks:</p>
                <ol>
                    <li>Skapa ett projekt i <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a></li>
                    <li>Aktivera Google Tasks API för projektet</li>
                    <li>Skapa en API-nyckel under "Credentials" (för identifiering)</li>
                    <li>Skapa OAuth 2.0-uppgifter (OAuth client ID) för webbapplikation</li>
                    <li>För att få en åtkomsttoken, använd <a href="https://developers.google.com/oauthplayground/" target="_blank">OAuth 2.0 Playground</a>:
                        <ul>
                            <li>Klicka på kugghjulet (inställningar) i övre högra hörnet</li>
                            <li>Markera "Use your own OAuth credentials"</li>
                            <li>Ange ditt Client ID och Client Secret från Google Cloud Console</li>
                            <li>Stäng inställningarna</li>
                            <li>Scrolla ner och hitta "Google Tasks API v1"</li>
                            <li>Markera "https://www.googleapis.com/auth/tasks"</li>
                            <li>Klicka på "Authorize APIs" och logga in med ditt Google-konto</li>
                            <li>När du får "redirect_uri_mismatch" fel, kopiera den URL:en som visas som "skulle ha omdirigerats till"</li>
                            <li>Gå till Google Cloud Console -> Credentials -> din OAuth 2.0 Client ID</li>
                            <li>Lägg till denna URL under "Authorized redirect URIs" och spara</li>
                            <li>Gå tillbaka till OAuth Playground och försök igen</li>
                            <li>Klicka på "Exchange authorization code for tokens"</li>
                            <li>Kopiera "Access token" (börjar med "ya29.")</li>
                        </ul>
                    </li>
                    <li>Fyll i API-nyckeln och åtkomsttokenen nedan</li>
                </ol>
            </div>
            
            <form id="credentials-form" action="{{ url_for('settings.set_credentials') }}" method="post">
                <div class="form-group">
                    <label for="api_key">Google API-nyckel:</label>
                    <input type="text" name="api_key" id="api_key" placeholder="AIzaSyA1B2C3D4E5F6G7H8I9J..." class="input-text" value="{{ 'XXXX-XXXX-XXXX...' if has_api_key else '' }}">
                </div>
                <div class="form-group">
                    <label for="access_token">Google Åtkomsttoken:</label>
                    <input type="text" name="access_token" id="access_token" placeholder="ya29.XXXX..." class="input-text" value="{{ 'XXXX-XXXX-XXXX...' if has_access_token else '' }}">
                    <p class="help-text">OBS: Åtkomsttokens går ut efter ca 1 timme. Om synkroniseringen slutar fungera behöver du förnya token.</p>
                </div>
                <button type="submit" class="btn">Spara autentiseringsuppgifter</button>
            </form>
        </div>
        {% else %}
        <!-- Show remove credentials option if authenticated -->
        <div class="auth-section">
            <h3>Autentiseringsuppgifter</h3>
            <p>Du är ansluten till Google Tasks med dina autentiseringsuppgifter.</p>
            <form id="remove-credentials-form" action="{{ url_for('settings.remove_credentials') }}" method="post">
                <button type="submit" class="btn btn-danger">Ta bort autentiseringsuppgifter</button>
            </form>
        </div>
        
        <div class="mappings-section">
            <h3>Kategori till Uppgiftslista Mappningar</h3>
            
            <!-- Current mappings -->
            {% if mappings %}
                <table class="settings-table">
                    <thead>
                        <tr>
                            <th>Kategori</th>
                            <th>Uppgiftslista</th>
                            <th>Åtgärd</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for mapping in mappings %}
                            <tr>
                                <td>{{ mapping.category }}</td>
                                <td>{{ mapping.tasklist_name }}</td>
                                <td>
                                    <form action="{{ url_for('settings.delete_mapping', mapping_id=mapping.id) }}" method="post" class="delete-mapping-form">
                                        <button type="submit" class="btn-small btn-danger">Ta bort</button>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>Inga mappningar konfigurerade.</p>
            {% endif %}
            
            {% if tasklists %}
                <!-- Add new mapping -->
                <h4>Lägg till ny mappning</h4>
                
                <form id="mapping-form" action="{{ url_for('settings.update_mapping') }}" method="post">
                    <div class="form-group">
                        <label for="category">Kategori:</label>
                        <select name="category" id="category" required class="input-select">
                            <option value="">Välj kategori...</option>
                            {% for category in unmapped_categories %}
                                <option value="{{ category }}">{{ category }}</option>
                            {% endfor %}
                            {% if not unmapped_categories %}
                                {% for category in categories %}
                                    <option value="{{ category }}">{{ category }} (redan mappat)</option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="tasklist_select">Uppgiftslista:</label>
                        <select name="tasklist_select" id="tasklist_select" class="input-select">
                            <option value="">Välj uppgiftslista...</option>
                            {% for tasklist in tasklists %}
                                <option value="{{ tasklist.id }}" data-name="{{ tasklist.title }}">{{ tasklist.title }}</option>
                            {% endfor %}
                        </select>
                        <input type="hidden" name="tasklist_id" id="tasklist_id">
                        <input type="hidden" name="tasklist_name" id="tasklist_name">
                    </div>
                    
                    <button type="submit" class="btn">Spara mappning</button>
                </form>
            {% endif %}
            
            <!-- Set default task list -->
            <h3>Standarduppgiftslista</h3>
            
            {% if default_tasklist %}
                <p>Nuvarande standarduppgiftslista: <strong>{{ default_tasklist.tasklist_name }}</strong></p>
            {% else %}
                <p>Ingen standarduppgiftslista inställd.</p>
            {% endif %}
            
            {% if tasklists %}
                <form id="default-form" action="{{ url_for('settings.set_default') }}" method="post">
                    <div class="form-group">
                        <label for="default_tasklist_select">Välj standarduppgiftslista:</label>
                        <select name="default_tasklist_select" id="default_tasklist_select" class="input-select">
                            <option value="">Välj uppgiftslista...</option>
                            {% for tasklist in tasklists %}
                                <option value="{{ tasklist.id }}" data-name="{{ tasklist.title }}">{{ tasklist.title }}</option>
                            {% endfor %}
                        </select>
                        <input type="hidden" name="tasklist_id" id="default_tasklist_id">
                        <input type="hidden" name="tasklist_name" id="default_tasklist_name">
                    </div>
                    
                    <button type="submit" class="btn">Spara som standard</button>
                </form>
            {% else %}
                <div class="alert error">
                    <p>Kunde inte hämta dina uppgiftslistor. Kontrollera att dina autentiseringsuppgifter är korrekta.</p>
                </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
    </div>
    
    <script>
        $(document).ready(function() {
            // Handle tasklist selection for mapping
            $('#tasklist_select').change(function() {
                const selectedOption = $(this).find('option:selected');
                const tasklistId = selectedOption.val();
                const tasklistName = selectedOption.data('name');
                
                $('#tasklist_id').val(tasklistId);
                $('#tasklist_name').val(tasklistName);
            });
            
            // Handle tasklist selection for default
            $('#default_tasklist_select').change(function() {
                const selectedOption = $(this).find('option:selected');
                const tasklistId = selectedOption.val();
                const tasklistName = selectedOption.data('name');
                
                $('#default_tasklist_id').val(tasklistId);
                $('#default_tasklist_name').val(tasklistName);
            });
            
            // Handle form submission with AJAX
            $('#credentials-form, #remove-credentials-form, #mapping-form, #default-form, .delete-mapping-form').submit(function(e) {
                e.preventDefault();
                const form = $(this);
                
                $.ajax({
                    type: 'POST',
                    url: form.attr('action'),
                    data: form.serialize(),
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    success: function(response) {
                        if (response.status === 'success' || response.success) {
                            alert(response.message || 'Åtgärden lyckades!');
                            // Reload page to show changes
                            location.reload();
                        } else {
                            alert(response.message || 'Ett fel uppstod.');
                        }
                    },
                    error: function(error) {
                        console.error("Error:", error);
                        alert('Ett fel uppstod. Försök igen.');
                    }
                });
            });
        });
    </script>
</body>
</html>