<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Förbrukningsmaterial</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class=background_wrapper></div>
    <div class=card>
    <h1>Inventera</h1>
    <p>kontrollera vad som finns kvar, inklusive <b>oöppnade</b> förpackningar (öppnade räknas inte) som är utställda, i text sovrum, dusch.</p>
    <p><a href=https://ha.snis.nu/ass-ds/0>Kalender m.m</a></p>

    {% for category, items in items_by_category.items() %}

        <h2>{{ category }}</h2>
        <table>
            <thead>
                <tr>
                    <th>Benämning</th>
                    <th>Antal</th>
                    <th>Check</th>
                    <th>Update</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                    <tr id="item-row-{{ item.id }}">
                        <form action="{{ url_for('update_quantity', item_id=item.id) }}" method="post" class="update-form">
                        <td id="item-name-{{ item.id }}" style="background-image: linear-gradient(to right, {{ get_warning_color(item.quantity, item.alert_quantity) }}, {{ get_row_color(item.last_checked) }})">{{ item.name }}</td>
                        <td id="item-quantity-{{ item.id }}" style="background-color: {{ get_row_color(item.last_checked) }}"><input type="hidden" name="item_id" value="{{ item.id }}">
                        <input type="number" name="new_quantity" value="{{ item.quantity }}"> {{ item.unit }}</td>
                        <td style="background-color: {{ get_row_color(item.last_checked) }}"><button class="apply" type="submit"></button></td>
                        <td id="item-updated-{{ item.id }}" style="background-color: {{ get_row_color(item.last_checked) }}">{% if item.last_checked %}{{ item.last_checked.strftime('%d/%m') }}{% endif %}</td>
                        </form>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endfor %}
    </div>

    <script>
        $(document).ready(function() {
            $('.update-form').submit(function(e) {
                e.preventDefault();
                var form = $(this);
                var url = form.attr('action');
                var itemId = form.find('input[name="item_id"]').val();
                var newQuantity = form.find('input[name="new_quantity"]').val();
                
                $.ajax({
                    type: "POST",
                    url: url,
                    data: form.serialize(),
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    success: function(response) {
                        if (response.status === 'success') {
                            // Update the row with new values
                            $('#item-updated-' + response.item_id).text(response.last_checked);
                            
                            // Update background colors
                            $('#item-name-' + response.item_id).css('background-image', 
                                'linear-gradient(to right, ' + response.warning_color + ', ' + response.row_color + ')');
                            $('#item-quantity-' + response.item_id).css('background-color', response.row_color);
                            $('#item-updated-' + response.item_id).css('background-color', response.row_color);
                            $(form).find('td').css('background-color', response.row_color);
                        }
                    },
                    error: function(error) {
                        console.error("Error updating item:", error);
                    }
                });
            });
        });
    </script>
</body>
</html>
